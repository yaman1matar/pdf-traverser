pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

async function handleFileUpload() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return alert("Please select a file first");

    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
    let fullText = "";

    // The transcript has 8 pages; we traverse them all [cite: 19, 129]
    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        fullText += content.items.map(item => item.str).join(" ") + " SEMESTER_BREAK ";
    }
    
    parseTechnionText(fullText);
}

function parseTechnionText(text) {
    // Regex matches: CourseID [cite: 16], Name [cite: 16], Credits [cite: 16], Grade [cite: 16]
    const pattern = /(\d{7}|\d{6})\s+([\u0590-\u05FF\w\s\-\(\)]+?)\s+(\d\.?\d?)\s+(\d{2,3}|\*?\d{2,3}|Pass|Exemption|Not completed|עבר)/g;
    
    // Filter out the current/future semesters (2025-2026) [cite: 103, 106]
    const pastText = text.split("2025-2026")[0]; 
    
    let match;
    const courseMap = {};

    while ((match = pattern.exec(pastText)) !== null) {
        const [_, id, name, credits, rawGrade] = match;
        const cleanGrade = rawGrade.replace('*', ''); // Remove the '*' Technion uses for Moed A [cite: 16]
        
        if (!courseMap[id]) {
            courseMap[id] = { name: name.trim(), credits: parseFloat(credits), attempts: [] };
        }
        courseMap[id].attempts.push(cleanGrade);
    }

    // Process the grouped courses into the UI
    Object.keys(courseMap).forEach(id => {
        const course = courseMap[id];
        // Determine the "Final" grade based on Technion rules
        let finalGrade = "0";
        let moedA = course.attempts[0] || "";
        let moedB = course.attempts[1] || "";

        // Success logic: If any attempt is "Pass" or 55+ [cite: 30, 47]
        const hasPassed = course.attempts.some(g => g === "Pass" || g === "עבר" || parseInt(g) >= 55);
        
        if (hasPassed) {
            finalGrade = course.attempts.find(g => g === "Pass" || g === "עבר" || parseInt(g) >= 55);
        } else if (course.attempts.includes("Not completed")) {
            finalGrade = "Failed";
        } else {
            finalGrade = moedB || moedA || "0";
        }

        addRow(course.name, course.credits, moedA, moedB, finalGrade);
    });
}

function calculate() {
    let totalWeightedPoints = 0;
    let creditsForAverage = 0;
    let totalCreditsEarned = 0;
    let totalExamAttempts = 0;
    let passedAttempts = 0;

    document.querySelectorAll('#tableBody tr').forEach(row => {
        const credits = parseFloat(row.querySelector('.credit-input').value) || 0;
        const moedA = row.querySelector('.moedA').value;
        const moedB = row.querySelector('.moedB').value;
        const final = row.querySelector('.final-cell').innerText;

        // Success Rate Logic:
        // 1. "Not completed" counts as a fail [cite: 47, 61]
        // 2. If Moed B exists, it replaces Moed A in the same semester success count
        if (credits > 0) {
            totalExamAttempts++; // Count the course instance
            
            if (final === "Pass" || final === "עבר" || parseInt(final) >= 55) {
                passedAttempts++;
                totalCreditsEarned += credits;
            }

            // Average Logic: Ignore "Pass" or non-numeric grades [cite: 30, 61]
            if (!isNaN(parseInt(final))) {
                totalWeightedPoints += (parseInt(final) * credits);
                creditsForAverage += credits;
            }
        }
    });

    document.getElementById('totalCredits').innerText = totalCreditsEarned;
    document.getElementById('average').innerText = creditsForAverage ? (totalWeightedPoints / creditsForAverage).toFixed(2) : 0;
    document.getElementById('successRate').innerText = totalExamAttempts ? ((passedAttempts / totalExamAttempts) * 100).toFixed(1) : 0;
}
